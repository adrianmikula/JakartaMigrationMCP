# mise-en-place (mise) configuration
# Tool version management and project setup
# Install mise: https://mise.jdx.dev/getting-started.html

[tools]
# Java 21 - Required for the project
java = "21.0.0"

# Mill - Build tool on Linux/macOS (faster startup); Gradle used on Windows
mill = "0.12.17"

# Node.js - Required for frontend development
node = "20.11.0"

# Docker - For containerized services
# Note: Docker version managed by system, not mise

# Ollama - LLM runtime
# Note: Ollama installed separately, not via mise

[env]
# Project-specific environment variables
# These are loaded when entering the project directory

# Database Configuration
DB_USERNAME = "postgres"
DB_PASSWORD = "postgres"

# Redis Configuration  
REDIS_HOST = "localhost"
REDIS_PORT = "6379"

# Ollama Configuration
OLLAMA_BASE_URL = "http://localhost:11434"
OLLAMA_MODEL = "deepseek-coder:6.7b"

# Repository Clone Path
REPO_CLONE_PATH = "./repos"

# Essential development workflow tasks
# For complete command reference, see COMMANDS.md

[tasks.setup]
description = "Full project setup - installs mise, tools, and starts services"
# Note: This task is typically run via the setup scripts which handle mise installation
# The scripts then call mise tasks for the actual setup work
run = "echo 'Please run: ./scripts/setup.ps1 (Windows) or ./scripts/setup.sh (Linux/Mac)'"

[tasks.start-services]
description = "Start Docker services (PostgreSQL and Redis)"
run_windows = "powershell -File scripts/start-services.ps1"
run = "bash scripts/start-services.sh"

[tasks.stop-services]
description = "Stop Docker services"
run_windows = "powershell -File scripts/stop-services.ps1"
run = "bash scripts/stop-services.sh"

# Free Modules Build Tasks (Apache 2.0)

[tasks.build]
description = "Build free modules (without tests). Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat :free-core-engine:compileJava :free-mcp-server:compileJava :free-intellij-plugin:compileJava"
run = "mill free_core_engine.compile free_mcp_server.compile free_intellij_plugin.compile"

[tasks.build-all]
description = "Build free modules with tests. Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat :free-core-engine:build :free-mcp-server:build :free-intellij-plugin:build"
run = "mill free_core_engine.compile free_core_engine.test free_mcp_server.compile free_mcp_server.test free_intellij_plugin.compile free_intellij_plugin.test"

[tasks.test]
description = "Run tests for all free modules. Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat :free-core-engine:test :free-mcp-server:test :free-intellij-plugin:test"
run = "mill free_core_engine.test free_mcp_server.test free_intellij_plugin.test"

[tasks.run]
description = "Run the free MCP server application. Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat :free-mcp-server:bootRun"
run = "mill free_mcp_server.run"

[tasks.assembly]
description = "Build fat JAR for free MCP server (for release). Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat :free-mcp-server:bootJar"
run = "mill free_mcp_server.assembly"

[tasks.clean]
description = "Clean build artifacts. Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat clean"
run = "mill clean"

# Individual Module Build Tasks

[tasks.build-core]
description = "Build free-core-engine module"
run_windows = "gradlew.bat :free-core-engine:compileJava"
run = "mill free_core_engine.compile"

[tasks.build-server]
description = "Build free-mcp-server module"
run_windows = "gradlew.bat :free-mcp-server:compileJava"
run = "mill free_mcp_server.compile"

[tasks.build-plugin]
description = "Build free-intellij-plugin module"
run_windows = "gradlew.bat :free-intellij-plugin:compileJava"
run = "mill free_intellij_plugin.compile"

# Docker Tasks

[tasks.docker-logs]
description = "View Docker service logs (follow mode)"
run = "docker compose logs -f"

[tasks.docker-ps]
description = "Check Docker services status"
run = "docker compose ps"

[tasks.db-connect]
description = "Connect to PostgreSQL database"
run = "docker exec -it jakarta-migration-postgres psql -U postgres -d jakarta_migration"

[tasks.redis-connect]
description = "Connect to Redis CLI"
run = "docker exec -it jakarta-migration-redis redis-cli"

[tasks.health]
description = "Check application health (requires app to be running)"
run = "curl http://localhost:8080/actuator/health"

# Frontend Development Tasks

[tasks.frontend-install]
description = "Install frontend dependencies"
run = "cd frontend && npm install"

[tasks.frontend-dev]
description = "Start frontend development server (Vite)"
run = "cd frontend && npm run dev"

[tasks.frontend-build]
description = "Build frontend for production"
run = "cd frontend && npm run build"

[tasks.frontend-preview]
description = "Preview production build locally"
run = "cd frontend && npm run preview"

[tasks.frontend-clean]
description = "Clean frontend build artifacts and node_modules"
run_windows = "powershell -c 'if (Test-Path \"frontend\\node_modules\") { Remove-Item -Recurse -Force \"frontend\\node_modules\" }; if (Test-Path \"frontend\\dist\") { Remove-Item -Recurse -Force \"frontend\\dist\" }; Write-Host \"Frontend cleaned\"'"
run = "bash -c 'rm -rf frontend/node_modules frontend/dist && echo \"Frontend cleaned\"'"

# Storybook Tasks

[tasks.storybook]
description = "Start Storybook development server (http://localhost:6006)"
run = "cd frontend && npm run storybook"

[tasks.storybook-build]
description = "Build Storybook for static hosting"
run = "cd frontend && npm run build-storybook"

# Premium Modules Build Tasks (Proprietary)

[tasks.build-premium]
description = "Build premium modules (without tests). Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat :premium-core-engine:compileJava :premium-mcp-server:compileJava :premium-intellij-plugin:compileJava"
run = "mill premium_core_engine.compile premium_mcp_server.compile premium_intellij_plugin.compile"

[tasks.build-premium-all]
description = "Build premium modules with tests. Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat :premium-core-engine:build :premium-mcp-server:build :premium-intellij-plugin:build"
run = "mill premium_core_engine.compile premium_core_engine.test premium_mcp_server.compile premium_mcp_server.test premium_intellij_plugin.compile premium_intellij_plugin.test"

[tasks.test-premium]
description = "Run tests for all premium modules. Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat :premium-core-engine:test :premium-mcp-server:test :premium-intellij-plugin:test"
run = "mill premium_core_engine.test premium_mcp_server.test premium_intellij_plugin.test"

[tasks.build-premium-plugin]
description = "Build premium IntelliJ plugin"
run_windows = "gradlew.bat :premium-intellij-plugin:buildPlugin"
run = "mill premium_intellij_plugin.compile"

# Community Modules Build Tasks (Apache 2.0)

[tasks.build-community]
description = "Build community modules (without tests). Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat :community-core-engine:compileJava :community-mcp-server:compileJava"
run = "mill community_core_engine.compile community_mcp_server.compile"

[tasks.test-community]
description = "Run tests for all community modules. Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat :community-core-engine:test :community-mcp-server:test"
run = "mill community_core_engine.test community_mcp_server.test"

# Fast Test Tasks (for quick feedback during development)

[tasks.fast-test]
description = "Run fast tests only - no compilation, just execute pre-built tests"
run_windows = "gradlew.bat :community-core-engine:test :premium-core-engine:test --continue"
run = "mill community_core_engine.test premium_core_engine.test"

[tasks.fast-compile]
description = "Quick compile check - no tests, just syntax verification"
run_windows = "gradlew.bat compileJava --parallel"
run = "mill __.compile"
