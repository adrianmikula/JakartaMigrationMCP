# mise-en-place (mise) configuration
# Tool version management and project setup
# Install mise: https://mise.jdx.dev/getting-started.html

[tools]
# Java 21 - Required for the project
java = "21.0.0"

# Mill - Build tool on Linux/macOS (faster startup); Gradle used on Windows
mill = "0.12.17"

# Node.js - Required for frontend development
node = "20.11.0"

# Docker - For containerized services
# Note: Docker version managed by system, not mise

# Ollama - LLM runtime
# Note: Ollama installed separately, not via mise

[env]
# Project-specific environment variables
# These are loaded when entering the project directory

# Database Configuration
DB_USERNAME = "postgres"
DB_PASSWORD = "postgres"

# Redis Configuration  
REDIS_HOST = "localhost"
REDIS_PORT = "6379"

# Ollama Configuration
OLLAMA_BASE_URL = "http://localhost:11434"
OLLAMA_MODEL = "deepseek-coder:6.7b"

# Repository Clone Path
REPO_CLONE_PATH = "./repos"

# Essential development workflow tasks
# For complete command reference, see COMMANDS.md

[tasks.setup]
description = "Full project setup - installs mise, tools, and starts services"
# Note: This task is typically run via the setup scripts which handle mise installation
# The scripts then call mise tasks for the actual setup work
run = "echo 'Please run: ./scripts/setup.ps1 (Windows) or ./scripts/setup.sh (Linux/Mac)'"

[tasks.start-services]
description = "Start Docker services (PostgreSQL and Redis)"
run_windows = "powershell -File scripts/start-services.ps1"
run = "bash scripts/start-services.sh"

[tasks.stop-services]
description = "Stop Docker services"
run_windows = "powershell -File scripts/stop-services.ps1"
run = "bash scripts/stop-services.sh"

[tasks.build]
description = "Build the project (without tests). Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat compileJava"
run = "mill jakartaMigrationMcp.compile"

[tasks.build-all]
description = "Build the project with tests. Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat build"
run = "mill jakartaMigrationMcp.compile jakartaMigrationMcp.test"

[tasks.test]
description = "Run all tests. Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat test"
run = "mill jakartaMigrationMcp.test"

[tasks.clean-test]
description = "Run tests cleanly without leaving orphaned processes (--no-daemon)"
run_windows = "gradlew.bat test --no-daemon"
run = "mill jakartaMigrationMcp.test"

[tasks.run]
description = "Run the application. Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat bootRun"
run = "mill jakartaMigrationMcp.run"

[tasks.assembly]
description = "Build fat JAR (for release). Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat bootJar"
run = "mill jakartaMigrationMcp.assembly"

[tasks.clean]
description = "Clean build artifacts. Linux/macOS: Mill; Windows: Gradle"
run_windows = "gradlew.bat clean"
run = "mill clean"

[tasks.kill-gradle-java]
description = "Stop Gradle daemons to avoid file locks on Windows before rebuild/retest"
run_windows = "powershell -NoProfile -ExecutionPolicy Bypass -File scripts/kill-gradle-java.ps1"
run = "bash -c 'gradlew --stop 2>/dev/null || true'"

[tasks.kill-gradle-java-force]
description = "Stop Gradle daemons and kill Gradle/project Java processes (use when file locks persist)"
run_windows = "powershell -NoProfile -ExecutionPolicy Bypass -File scripts/kill-gradle-java.ps1 -Force"
run = "bash -c 'gradlew --stop 2>/dev/null || true'"

[tasks.docker-logs]
description = "View Docker service logs (follow mode)"
run = "docker compose logs -f"

[tasks.docker-ps]
description = "Check Docker services status"
run = "docker compose ps"

[tasks.db-connect]
description = "Connect to PostgreSQL database"
run = "docker exec -it jakarta-migration-postgres psql -U postgres -d jakarta_migration"

[tasks.redis-connect]
description = "Connect to Redis CLI"
run = "docker exec -it jakarta-migration-redis redis-cli"

[tasks.health]
description = "Check application health (requires app to be running)"
run = "curl http://localhost:8080/actuator/health"

# Frontend Development Tasks

[tasks.frontend-install]
description = "Install frontend dependencies"
run = "cd frontend && npm install"

[tasks.frontend-dev]
description = "Start frontend development server (Vite)"
run = "cd frontend && npm run dev"

[tasks.frontend-build]
description = "Build frontend for production"
run = "cd frontend && npm run build"

[tasks.frontend-preview]
description = "Preview production build locally"
run = "cd frontend && npm run preview"

[tasks.frontend-clean]
description = "Clean frontend build artifacts and node_modules"
run_windows = "powershell -c 'if (Test-Path \"frontend\\node_modules\") { Remove-Item -Recurse -Force \"frontend\\node_modules\" }; if (Test-Path \"frontend\\dist\") { Remove-Item -Recurse -Force \"frontend\\dist\" }; Write-Host \"Frontend cleaned\"'"
run = "bash -c 'rm -rf frontend/node_modules frontend/dist && echo \"Frontend cleaned\"'"

# Storybook Tasks

[tasks.storybook]
description = "Start Storybook development server (http://localhost:6006)"
run = "cd frontend && npm run storybook"

[tasks.storybook-build]
description = "Build Storybook for static hosting"
run = "cd frontend && npm run build-storybook"

