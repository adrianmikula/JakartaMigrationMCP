---
description: Prefer mise run over direct mill/gradle for Java build tasks - Mandatory rule for all agents
alwaysApply: true
---

# mise Command Preference Rule (Mandatory for All KiloCode Agents)

## Overview

This rule is **MANDATORY** for all KiloCode agents working on the Jakarta Migration MCP project. All agents MUST prefer using `mise run` commands over direct `mill`, `gradlew`, or PowerShell invocations.

## Why Prefer mise Commands?

1. **Cross-Platform Consistency**: Mise automatically selects the right tool (Mill on Linux/macOS, Gradle on Windows)
2. **Version Pinning**: Mise ensures consistent tool versions across all developers
3. **Task Abstraction**: Mise tasks provide meaningful, documented commands that abstract implementation details
4. **Discoverability**: All available commands are documented in `.mise.toml` and can be listed with `mise task list`
5. **Maintainability**: When tool versions or commands change, only `.mise.toml` needs updating

## Mandatory Rules for All Agents

### Rule 1: Always Use mise run for Build Operations

**Never use direct gradlew or mill commands for standard operations.**

| Operation | ❌ Forbidden | ✅ Required |
|-----------|-------------|-------------|
| Compile Java | `./gradlew.bat compileJava` | `mise run build` |
| Run tests | `./gradlew.bat test` | `mise run test` |
| Build JAR | `./gradlew.bat bootJar` | `mise run assembly` |
| Run application | `./gradlew.bat bootRun` | `mise run run` |
| Clean artifacts | `./gradlew.bat clean` | `mise run clean` |
| Rebuild | `./gradlew.bat clean build` | `mise run rebuild` |

### Rule 2: Always Use mise run for Subproject Tasks

**Use module-specific mise tasks instead of gradle project references.**

| Subproject | Task | Forbidden | Required |
|------------|------|-----------|----------|
| migration-core | Compile | `:migration-core:compileJava` | `mise run build-migration-core` |
| migration-core | Test | `:migration-core:test` | `mise run test-migration-core` |
| mcp-server | Compile | `:mcp-server:compileJava` | `mise run build-mcp-server` |
| mcp-server | Test | `:mcp-server:test` | `mise run test-mcp-server` |
| mcp-server | Run | `:mcp-server:bootRun` | `mise run run-mcp-server` |
| intellij-plugin | Build | `:intellij-plugin:build` | `mise run build-intellij-plugin` |
| intellij-plugin | Test | `:intellij-plugin:test` | `mise run test-intellij-plugin` |

### Rule 3: Always Use mise run for Code Quality Tasks

**Never run quality tools directly.**

| Operation | Forbidden | Required |
|-----------|-----------|----------|
| Checkstyle | `gradlew.bat checkstyleMain` | `mise run checkstyle` |
| SpotBugs | `gradlew.bat spotbugsMain` | `mise run spotbugs` |
| PMD | `gradlew.bat pmdMain` | `mise run pmd` |
| Format code | `gradlew.bat spotlessApply` | `mise run format` |
| Check format | `gradlew.bat spotlessCheck` | `mise run format-check` |
| License headers | `gradlew.bat validateLicenseHeaders` | `mise run license-headers` |
| All validations | Multiple gradle commands | `mise run validate-all` |

### Rule 4: Always Use mise run for Docker and Database Tasks

**Use mise tasks for container and database operations.**

| Operation | Forbidden | Required |
|-----------|-----------|----------|
| Start services | `powershell scripts/start-services.ps1` | `mise run start-services` |
| Stop services | `powershell scripts/stop-services.ps1` | `mise run stop-services` |
| Docker logs | `docker compose logs -f` | `mise run docker-logs` |
| Docker status | `docker compose ps` | `mise run docker-ps` |
| DB connect | `docker exec -it ... psql` | `mise run db-connect` |
| Redis connect | `docker exec -it ... redis-cli` | `mise run redis-connect` |

### Rule 5: Always Use mise run for Frontend Tasks

**Use mise tasks for frontend development.**

| Operation | Forbidden | Required |
|-----------|-----------|----------|
| Install deps | `cd frontend && npm install` | `mise run frontend-install` |
| Dev server | `cd frontend && npm run dev` | `mise run frontend-dev` |
| Build | `cd frontend && npm run build` | `mise |
| Storybook run frontend-build` | `cd frontend && npm run storybook` | `mise run storybook` |
| Storybook build | `cd frontend && npm run build-storybook` | `mise run storybook-build` |

### Rule 6: Always Use mise run for Release Tasks

**Use mise tasks for release and publication.**

| Operation | Forbidden | Required |
|-----------|-----------|----------|
| Build release JAR | `gradlew.bat bootJar` | `mise run release-jar` |
| Build Docker | `docker build -t ...` | `mise run docker-build` |
| Build all release | Multiple commands | `mise run release-all` |

## Exception Cases (When mise is Unavailable)

The only acceptable exceptions are:

1. **mise not installed**: When the user explicitly confirms mise is not available
2. **User requests**: When the user explicitly asks for raw gradle/mill commands
3. **Troubleshooting**: When debugging build issues and mise is suspected to be the cause
4. **CI/CD pipelines**: When running in environments where mise is not configured (use gradle directly)

### Fallback Commands (Only for Exceptions)

When an exception applies, use these platform-appropriate fallbacks:

**Linux/macOS:**
```bash
mill jakartaMigrationMcp.<task>
# or
./mill <task>
```

**Windows:**
```powershell
.\gradlew.bat <task>
# or
gradlew.bat <task>
```

## Agent Response Template

When agents suggest or execute build commands, they MUST use this format:

```
✅ Recommended: `mise run <task-name>`

This command:
- Uses the project's pinned tool versions
- Works across all platforms
- Is documented in `.mise.toml`
- Can be discovered with `mise task list`

Example:
mise run build    # compiles Java sources
mise run test    # runs all tests
mise run run     # starts the application
```

## Common mise Tasks Quick Reference

### Daily Development
```bash
mise run build              # Compile code
mise run test              # Run tests
mise run run               # Run application
mise run rebuild           # Clean and rebuild
```

### Code Quality
```bash
mise run check             # All quality checks
mise run format            # Auto-format code
mise run format-check      # Check formatting
mise run validate-all      # All validations
```

### Subproject Tasks
```bash
mise run build-migration-core   # Core module
mise run build-mcp-server       # MCP server
mise run build-intellij-plugin  # IntelliJ plugin
```

### Services
```bash
mise run start-services   # Start Docker
mise run stop-services   # Stop Docker
mise run docker-ps       # Check status
mise run db-connect      # Connect to DB
```

### Frontend
```bash
mise run frontend-dev     # Dev server
mise run frontend-build  # Production build
mise run storybook       # Storybook
```

## Enforced Behavior

1. **All responses** about build/development commands MUST recommend mise
2. **All code** that invokes build tools MUST use mise tasks
3. **All documentation** MUST reference mise commands as primary
4. **All scripts** SHOULD delegate to mise tasks when possible

## References

- Mise documentation: https://mise.jdx.dev/
- Project mise config: `.mise.toml`
- List all tasks: `mise task list`
- Task details: `mise task list --verbose`
- Help: `mise run <task> --help`
